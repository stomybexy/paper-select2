<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">





<!--
An element providing a solution to no problem in particular.

Example:

    <paper-select2></paper-select2>

Example:

    <paper-select2>
      <h2>Hello paper-select2</h2>
    </paper-select2>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="paper-select2">
    <template>
        <style>
            :host {
                display: block;
                box-sizing: border-box;
            }
            
            .author img {
                display: block;
                float: left;
                margin-right: 5px;
                max-height: 100px;
                max-width: 100px;
            }
            
            paper-item {
                --paper-item: {
                    cursor: pointer;
                }
                ;
            }
            
            iron-dropdown {
                max-height: 400px;
                background: white;
                position: absolute;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            paper-material {
                
                z-index: 10;
            }

        </style>


        <div>

            <paper-input-container on-tap="open" hidden$="[[opened]]" readonly>
                <label hidden$="[[!label]]">[[label]]</label>
                <input id="val" is="iron-input" value="[[_computeItemLabel(selected)]]" bind-value="[[_computeItemLabel(selected)]]" type="text" class="dropdown-trigger">
            </paper-input-container>



        </div>
        <paper-input-container hidden$="[[!opened]]" on-tap="open">
            <label hidden$="[[!searchLabel]]">[[searchLabel]]</label>
            <input id="search" is="iron-input" bind-value="{{typedValue::input}}" type="search" class="dropdown-trigger" bind-value="{{typedValue::input}}" autofocus>
        </paper-input-container>
        <iron-dropdown vertical-align="down" id="dropdown" opened="{{opened}}" stop-keyboard-event-propagation>

            <paper-material elevation="1" class="dropdown-content">


                <paper-listbox attr-for-selected="value" on-tap="_onSelect" selected="{{selected}}" stop-keyboard-event-propagation>
                    <template is="dom-repeat" items="[[filterFn(data.*, typedValue)]]" id="domRepeat">
                        <paper-item value="[[item]]">[[_computeItemLabel(item)]]</paper-item>
                    </template>

                </paper-listbox>
            </paper-material>
        </iron-dropdown>


        <!--
        <paper-dropdown-menu label="Dinosaurs" opened='{{opened}}' noink no-animations id="dropdown" stop-keyboard-event-propagation>
            <div class="dropdown-content">
               <paper-input-container hidden$="[[!opened]]" stop-keyboard-event-propagation>
                    <label hidden$="[[!searchLabel]]">[[searchLabel]]</label>
                    <input is="iron-input" bind-value="{{typedValue::input}}" type="search" class="dropdown-trigger" bind-value="{{typedValue::input}}" autofocus on-tap="open">
                </paper-input-container>
                <paper-listbox attr-for-selected="value" on-tap="_onSelect" selected="{{selected}}">
                    <template is="dom-repeat" items="[[filterFn(data.*, typedValue)]]" id="domRepeat">
                        <paper-item value="[[item]]">[[_computeItemLabel(item)]]</paper-item>
                    </template>

                </paper-listbox>
            </div>
        </paper-dropdown-menu>
-->

    </template>

    <script>
        Polymer({
            is: 'paper-select2',

            properties: {
                /**
                 * `fancy` indicates that the element should don a monocle and tophat,
                 * while checking its pocket watch.
                 */
                fancy: Boolean,

                /**
                 * Describes the author of the element, but is really just an excuse to
                 * show off JSDoc annotations.
                 *
                 * @type {{name: string, image: string}}
                 */
                author: {
                    type: Object,
                    // Use `value` to provide a default value for a property, by setting it
                    // on your element's prototype.
                    //
                    // If you provide a function, as we do here, Polymer will call that
                    // _per element instance_.
                    //
                    // We do that to ensure that each element gets its own copy of the
                    // value, rather than having it shared across all instances (via the
                    // prototype).
                    value: function () {
                        return {
                            name: 'Dimitri Glazkov',
                            image: 'http://addyosmani.com/blog/wp-content/uploads/2013/04/unicorn.jpg',
                        };
                    }
                },
                data: {
                    type: Array,
                    notify: true,
                    value: function () {
                        return [

                        ];
                    }
                },
                label: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true,
                    value: ''
                },
                searchLabel: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true,
                    value: ''
                },
                _data: {
                    type: Array,
                    notify: true,
                    computed: 'filterFn(data.*, typedValue)'
                },
                attrForLabel: String,
                attrForSelected: String,
                selected: {
                    type: Object,
                    notify: true,
                    reflectToAttribute: true
                },
                typedValue: {
                    type: String,
                    notify: true,
                    value: null
                },
                _opened: {
                    type: Boolean,
                    notify: true,
                    value: false
                }
            },


            // Element Lifecycle

            ready: function () {
                // `ready` is called after all elements have been configured, but
                // propagates bottom-up. This element's children are ready, but parents
                // are not.
                //
                // This is the point where you should make modifications to the DOM (when
                // necessary), or kick off any processes the element wants to perform.
            },

            attached: function () {
                // `attached` fires once the element and its parents have been inserted
                // into a document.
                //
                // This is a good place to perform any work related to your element's
                // visual state or active behavior (measuring sizes, beginning animations,
                // loading resources, etc).
            },

            detached: function () {
                // The analog to `attached`, `detached` fires when the element has been
                // removed from a document.
                //
                // Use this to clean up anything you did in `attached`.
            },

            // Element Behavior

            /**
             * Sometimes it's just nice to say hi.
             *
             * @param {string} greeting A positive greeting.
             * @return {string} The full greeting.
             */
            sayHello: function (greeting) {
                var response = greeting || 'Hello World!';
                return 'paper-select2 says, ' + response;
            },

            /**
             * The `paper-select2-lasers` event is fired whenever `fireLasers` is called.
             *
             * @event paper-select2-lasers
             * @detail {{sound: String}}
             */

            /**
             * Attempt to destroy this element's enemies with a beam of light!
             *
             * Or, at least, dispatch an event in the vain hope that someone else will
             * do the zapping.
             */
            fireLasers: function () {
                this.fire('paper-select2-lasers', {
                    sound: 'Pew pew!'
                });
            },
            open: function () {
                this.$.dropdown.open();
                this.opened = true;
                this.$.search.focus();
            },
            _computeItemLabel: function (item) {
                if (!item) return;
                return (this.attrForLabel && item[this.attrForLabel]) || item;
            },
            _onSelect: function (e) {
                //                this.typedValue=null;
                var self = this;
                this.$.dropdown.close();
                setTimeout(function () {
                    self.$.val.focus();

                }, 0)
            },
            filterFn: function (data, value) {
                var self = this;

                var r = RegExp(value, 'i');

                if (!value) {
                    return this.data;
                }

                return this.data.filter(function (v) {
                    return (r.test(self._computeItemLabel(v)) ? v : null);
                });
            }


        });
    </script>
</dom-module>